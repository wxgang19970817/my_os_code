# 2_编写MBR主引导记录

## 文件结构

### bochsrc.disk

bochs 的启动文件

### mbr.S

1. 主引导汇编文件文件，大小为512字节
2. 利用 nasm 汇编器将其编译为 二进制文件（.bin）
3. 利用 dd 命令 将二进制文件写入虚拟硬盘第一扇区
4. bochs 自带 BIOS 会将其从硬盘第一扇区中加载到 0x7c00 处
5. **此版本功能**：**利用BIOS建立的中断，打印字符串**

### hd.img

虚拟硬盘文件 ata0，Primary通道，主盘

## 学习心得

### 计算机的启动过程

1. 开机的一瞬间，CPU的cs:ip寄存器就被强制初始化为0xF000:0xFFF0，此处有跳转指令，会跳转到0xfe05b处，进入BIOS。
2. BIOS检测内存，显卡等外设信息，之后初始化硬件，在低地址处建立数据结构，中断向量表IVT并填写中断例程。
3. 最后校验启动盘中位于0盘0道1扇区的内容，如果最后两字节是0x55和0xaa,便将该程序(MBR)加载到物理地址0x7c00处，并跳转。
4. **此程序**中的MBR利用BIOS在第二步建立好的中断例程，实现打印字符的功能，从而证明我们MBR确实被BIOS从磁盘加载到了内存中。具体的中断号的使用方法上网查BIOS.

## 基础知识

1. **BIOS**:Base Input & Output System，基本输入输出系统
2. **实模式下的内存布局**：一般整个内存空间由好几部分组成，比如我们电脑中装的内存条，属于DRAM,动态随机访问内存，还有显存，硬盘控制器等
3. **MBR 主引导程序**　因为MBR最大也就512字节(一个扇区),没法为内核准备好环境，更没办法将内核加载到内存中，所以真正加载内核的任务要交给另一个程序，而MBR的作用就是将这个程序加载到内存中，并转交控制权。
4. **内存空间**：平时我们常说的PC机里的内存条指的就是DRAM,在实模式下的内存布局中(或者说在我们经常见到各种内存布局图中)，内存条只占其中一部分区域，剩下的地址空间是预留出来留给外设的，如显存、硬盘控制器等，当然还有ROM区域。
5. 基于上面一点分析，BIOS是需要断电能保存的，所以合理来讲，BIOS就是被写在实模式下映射在低端1M空间的顶端的ROM中
6. 对**$和$$**:这两个在汇编中常见的关键字，是NASM预留的，用来表示当前行和本section的地址，属于伪指令，经过编译器编译后转换成CPU可识别的东西，如指令或地址等
7. **bin和elf**:bin是指纯二进制，只有指令；而elf和pe格式的二进制可执行文件，有很多和指令无关的东西，如程序的内存布局、位置等信息

