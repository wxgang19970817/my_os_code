# 14_文件系统

## 概念简介

### inode、间接块索引表、文件控制块FCB

- 硬盘是低速设备，其读写速度单位是扇区，为了避免频繁访问硬盘，操作系统不会有了一块扇区就去读写一次磁盘，往往等待数据积攒到“足够大小”时才一次性访问硬盘，这足够大小的数据就是块。一个块是由多个扇区组成的，块大小是扇区的整数倍
- 在Windows中，块被称为簇。比如在Windows中格式化分区时，若选择文件系统类型是FAT32，我们还可以选择多种不同大小的簇
- 文件的组织方式：就拿FAT来说，FAT称为文件分配表，在此文件系统中存储的文件，其所有的块被用于链式结构来组织，在每个块的最后存储下一个块的地址。好处是文件可以不连续存储，提升了磁盘的利用率，缺点是通过链式结构来组织文件的弊端是当访问文件中的某个块时，必须要从头开始遍历结点，所以后来微软推出了NTFS文件系统
- UNIX操作系统中的索引结构－inode比较先进，它将文件以索引结构来组织，避免了访问某一数据块需要从头把其前所有数据块再遍历一次的缺点。采用索引结构的文件系统，文件中的块依然可以分散到不连续的零散空间中，保留了磁盘高利用率的优点，更重要的是文件系统为每个文件的所有块建立了一个索引表，索引表就是块地址数组，每个数组元素就是块地址，数组元素的下标是文件块的索引，第n个数组元素指向文件中的第n个块，这样访问任意一个块的时候，只要从索引表中获得块地址就好了
- 包含此索引表的索引结构称为inode，即index node，索引结点，用来索引、跟踪一个文件的所有块。在UNIX文件系统中，一个文件必须对应一个inode，磁盘中有多少文件就有多少inode
- 用索引表结构的缺点是索引表本身要占用一定的存储空间，文件要很大时，块就比较多，索引表项就要跟着增多。为了解决这个问题UNIX采用了折中的办法：每个索引表中共15个索引项，暂时称此索引表为老索引表，老索引表的前12个索引项是文件的前12个块的地址，它们是文件的直接块，即可直接获得地址的块。若文件大于12个块，那就再建立个新的块索引表，新索引表称为一级间接块索引表，表中可容纳256个块的地址，每个块的地址存储在各个表项中。这256个块地址需要通过一级间接块索引表才能获得，所以称间接块。此表也需要一个物理块来存储，这个物理块的地址存储到了老索引表的第13个索引项中。目前可以存储的是12+256=268个块。如果文件超过了268，就再建立二级间接块索引表，此表中的各表项存储的是一级间接块索引表，然后在老索引表中的第14个索引项存储二级间接索引表所在块的地址
- 文件系统为实现文件管理方案，必然会创造处一些辅助管理的数据结构。只要用于管理、控制文件相关信息的数据结构都被称为FCB(FIle Contrl Block)，即文件控制块，inode也是这种结构，因此inode是FCB的一种。inode相当于是文件实体数据块的描述符，里面规定了访问此文件数据块的权限、属主等安全方面的条件、文件数据块总大小、文件实体数据块等。一个文件一个inode，多个inode会组成inode数组。inode逻辑结构中的i结点编号就是指在数组中的下标；权限是指读、写、执行；属主是指文件的拥有者，时间是指创建时间、修改时间、访问时间等。
- 核心点：**inode是文件在文件系统上的元信息，文件本身的元信息是它自己的文件头**
- 为方便管理，分区中所有文件的inode通过一个大表格来维护，此表格称为inode_table，本质上就是inode数组

### 目录项与目录简介

- 用户是通过用户名来访问文件的，但是inode中是没有文件名的。文件系统是如何把文件名和inode关联到一起的呢？
- 在Linux中，目录和文件都用inode来表示，因此目录也是文件，只是目录是包含文件的文件
- 目录文件和一般文件用到的inode结构是一样的，两者的区别在于inode指向的数据块的内容的不同。一般文件inode指向的数据块中的内容是普通文件自己的数据，目录文件指向的数据块中的内容应该是该目录下的目录项，因此目录中要么是普通文件的目录项，要么是目录的目录项
- 目录相当于是个文件列表，每个文件在目录中都是一个entry(条目、项)，各个entry包括inode编号、文件名、文件类型
- 有了目录项之后，通过文件名查找文件实体数据块的流程是：
  1. 在目录中找到文件名所在的目录项
  2. 从目录项中获取inode编号
  3. 用inode编号作为inode数组的索引下标，找到inode
  4. 从该inode中获取数据块的地址，读取数据块

- 梳理总结：
  - 每个文件都有自己单独的inode，inode是文件实体数据块在文件系统上的元信息
  - 所有文件的indoe集中管理，形成indoe数组，每个inode的编号就是在该inode数组中的下标
  - inode中的前12个直接数据块指针和后3个间接块索引表用于指向文件的数据块实体
  - 文件系统中并不存在具体称为"目录"的数据结构，同样也没有称为"普通文件"的数据结构，统一用同一种inode表示。inode表示的文件是普通文件，还是目录文件，取决于inode所指向数据块中的实际内容是什么，即数据块中的内容要么是普通文件本身的数据，要么是目录中的目录项
  - 目录项仅存在于inode指向的数据块中，有目录项的数据块就是目录
  - 目录下中记录的是文件名、文件indoe的编号和文件类型，目录项起到的作用有两个，一是粘合文件名及inode,使文件名和inode关联绑定，二是标识此inode所指向的数据块中的数据类型(比如是普通文件，还是目录，当然还有更多的类型)
  - inode是文件的"实质"，但它并不能直接引用，必须通过文件名找到文件名所在的目录项，然后从该目录项中获得inode编号，然后用此编号到inode数组中去找相关inode，最终找到文件的数据块

- 每个分区都有自己的根目录，它是所以目录的父目录，创建文件系统之后它的位置就是固定不变的

### 超级块与文件系统布局

- 对于文件系统，我们需要在某个固定地方去获取文件系统元信息的配置，这个地方就是超级块。超级块是保存文件系统元信息的元信息
- 超级块是文件系统元信息的“配置文件”，它是在为分区创建文件系统时创建的，它的位置和大小不能再被“配置”了，必须是固定的，它被固定存储在各分区的第2个扇区，通常是占用一个扇区的大小
- 超级块里的内容有魔数、inode数组的地址和大小、inode位图地址和大小、根目录的地址和大小、空闲块位图的地址和大小等
- 硬盘文件系统的布局如drawio文件所示

## 创建文件系统

### 创建文件系统

- 创建文件系统就是创建文件系统所需要的元信息，这包括超级块位置及大小、空闲块位图的位置及大小、inode位图的位置及大小、inode数组的位置及大小、空闲块起始地址、根目录起始地址。创建步骤：
  - 根据分区part大小，计算分区文件系统各元信息需要的扇区数及位置
  - 在内存中创建超级块，将以上步骤计算的元信息写入超级块
  - 将超级块写入磁盘
  - 将元信息写入磁盘上各自的位置
  - 将根目录写入磁盘

### 挂载分区

- Linux内核所在的分区是默认分区，自系统启动后就以该分区为默认分区，该分区的根目录是固定存在的，要想使用其他新分区的话，需要用mount命令手动把新的分区挂载到默认分区的某个目录下。尽管其它分区都有自己的根目录，但默认分区的根目录才是所有分区的父目录
- 无论是安装windows，还是Linux，安装过程中都是先选择安装到哪个分区上，然后选择以什么文件系统来格式化该分区，Windows系统通常是fat32或ntfs，在为该分区格式化出文件系统之后才开始正式的安装
- 挂载分区的实质是把该分区文件系统的元信息从硬盘上读出来加载到内存中，这样硬盘资源的变化都用内存中元信息来跟踪，如果有写操作，及时将内存中　的元信息同步写入到硬盘以持久化。

## 文件描述符简介

### 文件描述符原理

- Linux中所有文件操作都基于文件描述符
- 文件描述符即file descriptor，所描述的对象是文件的操作，比如文件打开后的文件读写偏移量等信息，indoe用于描述文件存储相关信息
- 详细描述：Linux读写文件的本质是先通过文件的inode找到文件数据块的扇区地址，随后读写该扇区，从而实现了文件的读写。几乎所以操作系统都允许一个进程同时、多次、打开同一个文件（并不关闭），同样该文件也可以被多个不同的进程同时打开。为了实现文件任意位置的读写，执行读写操作时可以指定偏移量作为该文件内的起始地址，此偏移量相当于文件的指针。文件每被打开一次就会产生一个文件结构，专门用于记录与文件操作相关的信息，所以才能实现不同进程对同一文件的多次读写都是各自操作各自的，任意一个文件操作的偏移量都不影响其他文件操作的偏移量。
- Linux把所有的“文件结构”组织到一起形成数组统一管理，该数组称为文件表
- 文件与inode一一对应，一个文件仅有一个inode，一个inode仅对应一个文件；一个文件可以被多次打开，所以一个inode可以对应多个文件结构
- Linux的进程可打开的最大文件数是有限的，因为打开一个文件就会产生一个文件结构，一旦打开的多了所占用的空间也是很庞大的
- 为了一视同仁，使各进程可打开的文件数是一样的，各进程必须有独立的、大小完全一样的一套文件描述符数组，而不能所有进程共享同一套文件描述符数组
- 文件结构中包含进程执行文件操作的偏移量，它属于与各个文件单独绑定的资源，因此最好放在PCB中管理
- 所以不会把“真正的、庞大的”文件表塞到狭小的一页PCB中，一般只在PCB中建立个文件描述符数组。当用户进程打开文件时，文件系统给用户进程返回的是该进程PCB中文件描述符数组下标值，也就是文件描述符
- Linux如何通过文件描述符找到文件？某进程把文件描述符作为参数提交给文件系统时，文件系统用此文件描述符在该进程的PCB中的文件描述符数组中索引对应的元素，从该元素中获取对应的文件结构的下标，用该下标在文件表中索引相应的文件结构，从该文件结构中获取文件的inode，最终找到了文件的数据块。若该inode在inode队列中不存在，此时会多一个处理过程：文件系统会从硬盘上将该inode加载到inode队列中，并使文件结构的fd_inode指向它
- inode队列中的所有inode应该被所有任务共享，包括内核线程和进程

## 创建文件

- 创建文件的要点：
  - 文件需要inode来描述大小、位置等属性，所以会创建文件就要创建inode，这就涉及到向inode_bitmap申请位图来获得inode号，inode_table数组中的某项也会由新的inode填充
  - inode->i_sectors是文件具体存储的扇区地址，这需要向block_bitmap申请可用位来获得可用块，block_bitmap会被更新，分区的数据区data_start_lba以后的某个扇区会被分配
  - 新增加的文件必然存在于某个目录，所以该目录的inode->i_size会增加个目录项的大小
  - 以上更改的内容要同步到硬盘

