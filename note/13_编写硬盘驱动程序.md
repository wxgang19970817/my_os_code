# 13_编写硬盘驱动程序

## 硬盘及分区表

### 创建磁盘分区表

- 文件系统是运行在操作系统中的软件算法，是操作系统提供的一套管理磁盘文件的读写的方法和数据组织、存储形式，因此，文件系统＝数据结构＋算法。**文件系统是程序**
- 它的管理对象是文件，管辖范围是分区，因此它建立在分区的基础上，每个分区都可以有不同的文件系统。
- 分区：是由多个编号连续的柱面组成的。分区的起始和终止都落在完整的柱面上，并不会出现多个分区共享同一柱面的情况，这就是所谓的“分区粒度”。
- 一般情况下，每磁道扇区数都是63，扇区大小都是512
- 分区是逻辑上划分磁盘空间的方式，归根结底是人为地将硬盘上的柱面扇区划分成不同的分组，每个分组都是单独的分区。各分区都有“描述符”来描述分区本身所在硬盘上的起止界限等信息，在硬盘的MBR中有个64字节“固定大小”的数据结构，这就是著名的**分区表**，分区表中的每个表项就是一个分区的“描述符”，表项大小是16字节，因此64字节的分区表总共可容纳4个表项
- 分区表必须存在于MBR引导扇区或EBR引导扇区中，在这512字节中，前446字节是硬盘参数和引导程序，然后才是64字节的分区表，最后是2字节的魔数55aa
- 在“描述符”的结构中有一个属性是文件系统id，它表示文件系统的类型。为了支持更多的分区，专门增加一种id属性值（id为5），用来表示该分区可被再次划分出更多的子分区，这就是逻辑分区，第一个逻辑分区的编号从5开始
- 4个分区中的任意一个都可以当做扩展分区，剩下的三个分区被称为主分区
- 扩展分区是可选项，有没有都可以，但最多只有一个，因为一个扩展分区理论上可以被划分出任意多个子分区
- 虽然理论上可以划分出无数个子分区，但是实际上由于硬盘的限制，逻辑分区的数量也是有限的，比如ide硬盘只支持63个分区，scsi硬盘只支持15个分区

### 磁盘分区表浅析

- 磁盘分区表(Disk Partition Table)简称IDT，是由多个分区信息汇成的表，表中每一个表项都对应一个分区，主要记录各个分区的起始扇区地址，大小界限等
- 分区表通常是由分区工具如fdisk创建的，但确实给操作系统使用的，因为通常情况下操作系统直接安装在某个分区上，所以分区表要在内核安装之前建立好，因此分区工具通常独立于操作系统
- 主引导扇区三部分：
  - 主引导记录MBR，其中包括硬盘参数及部分指令（由BIOS跳入执行），它是由分区工具产生的、独立于任何操作系统
  - 磁盘分区表DPT、总共64字节大小，每个分区表项是16字节，因此磁盘分区表最大支持4个分区
  - 结束魔数55AA，作为主引导扇区的有效标志

- MBR所在的磁道就不划入分区了，除去此磁道，这部分剩余的空间是62个扇区
- 总扩展分区被直接拆分成多个子扩展分区，子扩展分区又被拆分成EBR引导扇区、空闲扇区和逻辑分区三部分。MBR只有一个，EBR(扩展引导记录)可以有无数个
- EBR不属于分区内，不属于操作系统管理的范围。而OBR(操作系统引导记录)位于分区（主分区和逻辑分区）最开始的扇区，属于操作系统管理的范围
- 文件系统类型是指NTFS、FAT32、EXT2等

## 编写硬盘驱动程序

- 驱动程序是对硬件接口的封装，它把参数设置等重复、枯燥、复杂的过程封装成一个过程，避免每次执行命令时，都做重复工作